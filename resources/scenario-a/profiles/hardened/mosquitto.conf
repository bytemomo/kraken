# =============================================================================
# Global Settings
# =============================================================================
persistence true
persistence_location /mosquitto/data/
log_dest stdout
log_type error
log_type warning
log_type notice

per_listener_settings true

# Bind default listener to localhost only (unreachable from network)
listener 1883 127.0.0.1
max_connections 0

# Strict ACL enforcement
acl_file /mosquitto/config/acl.conf

# Password file (backup auth, mTLS is primary)
password_file /mosquitto/config/passwd

# Connection limits for DoS protection
max_connections 100
max_inflight_messages 20
max_queued_messages 1000

# =============================================================================
# NO PLAINTEXT LISTENER
# Port 1883 is intentionally not configured
# =============================================================================

# =============================================================================
# Listener 1: TLS MQTT (Port 8883)
# SECURE: TLS 1.3, auth required, but no client certs (password auth)
# This is for clients that cannot do mTLS
# =============================================================================
listener 8883
protocol mqtt
allow_anonymous false

# TLS Configuration - Strong settings
cafile /mosquitto/certs/ca.crt
certfile /mosquitto/certs/server.crt
keyfile /mosquitto/certs/server.key

# Enforce TLS 1.3 only
tls_version tlsv1.3
ciphers_tls1.3 TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256

# =============================================================================
# Listener 2: mTLS MQTT (Port 8884)
# SECURE: Full mTLS with client certificate required
# =============================================================================
listener 8884
protocol mqtt
allow_anonymous false

# TLS Configuration
cafile /mosquitto/certs/ca.crt
certfile /mosquitto/certs/server.crt
keyfile /mosquitto/certs/server.key

# Require client certificates (mTLS)
require_certificate true
use_identity_as_username true

# Enforce TLS 1.3 only
tls_version tlsv1.3
ciphers_tls1.3 TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256

# =============================================================================
# $SYS Topic Restriction
# Reduce exposure of system information
# =============================================================================
sys_interval 0
# Setting to 0 disables $SYS updates (no information disclosure)
